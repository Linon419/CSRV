<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>潜力区币回测工具</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial;padding:20px;}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    label{font-size:14px}
    input,select,button{padding:6px 8px;font-size:14px}

    /* 图表和侧边栏容器 */
    .main-container{display:flex;gap:12px;margin-bottom:8px;}
    .chart-area{flex:1;min-width:0;}
    #chart{width:100%;height:600px;border:1px solid #e6e6e6;}

    .legend{font-size:13px;margin:8px 0;}
    .legend span{display:inline-flex;align-items:center;margin-right:10px;}
    .legend i{display:inline-block;width:20px;height:3px;margin-right:5px;border-radius:2px;}

    /* 侧边观察列表 */
    .sidebar{
      width:320px;
      height:600px;
      background:#f7f7f7;
      border-radius:8px;
      display:flex;
      flex-direction:column;
      transition:width 0.3s ease, opacity 0.3s ease;
      overflow:hidden;
      flex-shrink:0;
    }
    .sidebar.collapsed{
      width:40px;
    }
    .sidebar.collapsed .sidebar-content{
      opacity:0;
      pointer-events:none;
    }
    .sidebar.collapsed .sidebar-header{
      justify-content:center;
      padding:10px 0;
    }
    .sidebar.collapsed .sidebar-header h3{
      display:none;
    }
    .sidebar-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px;
      background:#e6e6e6;
      border-radius:8px 8px 0 0;
    }
    .sidebar-header h3{
      margin:0;
      font-size:15px;
      white-space:nowrap;
    }
    .toggle-btn{
      background:none;
      border:none;
      cursor:pointer;
      padding:4px 8px;
      font-size:18px;
      line-height:1;
    }
    .sidebar-content{
      flex:1;
      overflow-y:auto;
      padding:10px;
      transition:opacity 0.3s ease;
    }

    #history-filters{margin-bottom:10px;display:flex;flex-direction:column;gap:6px;}
    #history-filters label{display:flex;flex-direction:column;font-size:12px;}
    #history-filters input{font-size:12px;padding:4px 6px;}
    #history-filters button{font-size:12px;padding:4px 8px;}

    .history-item{cursor:pointer;padding:8px;margin:4px 0;background:#fff;border-radius:5px;font-size:12px;border-left:3px solid transparent;}
    .history-item:hover{background:#e8f5e9;border-left-color:#4caf50;}
    .history-item.top-zone{border-left-color:#f44336;}
    .history-item.bottom-zone{border-left-color:#4caf50;}

    .history-controls{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .history-controls button{font-size:11px;padding:4px 6px;}

    .hint{color:#666;margin-top:6px;font-size:13px}

    /* 技术指标面板 */
    .indicators-panel{
      background:#f9f9f9;
      border:1px solid #ddd;
      border-radius:6px;
      padding:12px;
      margin-bottom:12px;
    }
    .indicator-group{
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid #e0e0e0;
    }
    .indicator-group:last-child{
      border-bottom:none;
    }
    .indicator-group h4{
      margin:0 0 8px 0;
      font-size:14px;
      color:#333;
    }
    .indicator-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .indicator-row label{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:13px;
    }

    /* 回测工具面板 */
    .backtest-panel{
      background:#f9f9f9;
      border:1px solid #ddd;
      border-radius:6px;
      padding:15px;
      margin-top:10px;
    }
    .backtest-controls{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:15px;
      margin-bottom:15px;
    }
    .backtest-settings h4,
    .backtest-actions h4,
    .backtest-stats h4,
    .backtest-trades h4{
      margin:0 0 10px 0;
      font-size:14px;
      color:#333;
    }
    .backtest-settings label,
    .backtest-actions label{
      display:block;
      margin-bottom:8px;
      font-size:13px;
    }
    .backtest-settings input,
    .backtest-settings select{
      width:120px;
      margin-left:5px;
    }
    .trade-btn{
      padding:8px 16px;
      font-size:13px;
      font-weight:bold;
      border:none;
      border-radius:4px;
      cursor:pointer;
      flex:1;
    }
    .long-btn{
      background:#26a69a;
      color:white;
    }
    .long-btn:hover{
      background:#2bbbad;
    }
    .long-btn:disabled{
      background:#ccc;
      cursor:not-allowed;
    }
    .short-btn{
      background:#ef5350;
      color:white;
    }
    .short-btn:hover{
      background:#f44336;
    }
    .short-btn:disabled{
      background:#ccc;
      cursor:not-allowed;
    }
    .close-btn{
      background:#ff9800;
      color:white;
    }
    .close-btn:hover{
      background:#fb8c00;
    }
    .close-btn:disabled{
      background:#ccc;
      cursor:not-allowed;
    }
    .backtest-stats{
      background:#fff;
      padding:10px;
      border-radius:4px;
    }
    .stat-item{
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
      font-size:13px;
    }
    .stat-item span{
      color:#666;
    }
    .stat-item strong.profit{
      color:#26a69a;
    }
    .stat-item strong.loss{
      color:#ef5350;
    }
    .stat-item strong.neutral{
      color:#666;
    }
    .position-status{
      font-size:12px;
      padding:2px 8px;
      border-radius:3px;
      margin-left:10px;
    }
    .position-status.long{
      background:#26a69a;
      color:white;
    }
    .position-status.short{
      background:#ef5350;
      color:white;
    }
    .trades-list{
      max-height:300px;
      overflow-y:auto;
      background:#fff;
      padding:10px;
      border-radius:4px;
      font-size:12px;
    }
    .trade-record{
      display:grid;
      grid-template-columns:80px 120px 100px 100px 100px 80px;
      gap:10px;
      padding:8px;
      border-bottom:1px solid #eee;
      align-items:center;
    }
    .trade-record:last-child{
      border-bottom:none;
    }
    .trade-record.header{
      font-weight:bold;
      background:#f5f5f5;
      position:sticky;
      top:0;
      z-index:1;
    }
    .trade-type{
      padding:2px 6px;
      border-radius:3px;
      text-align:center;
      font-weight:bold;
      font-size:11px;
    }
    .trade-type.long{
      background:#e0f7f4;
      color:#26a69a;
    }
    .trade-type.short{
      background:#ffebee;
      color:#ef5350;
    }
    .trade-type.close{
      background:#fff3e0;
      color:#ff9800;
    }
  </style>
  <script src="https://unpkg.com/lightweight-charts@3.7.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <h2>潜力区币回测工具</h2>

  <div class="controls">
    <label>交易对: <input id="symbol" value="BTCUSDT" /></label>
    <label>时间: <input id="time" type="datetime-local" /></label>
    <label>周期:
      <select id="interval">
        <option value="1m" selected>1m</option>
        <option value="3m">3m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="30m">30m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
    </label>
    <label>区域类型:
      <select id="zone-type">
        <option value="bottom">兜底区</option>
        <option value="top">探顶区</option>
      </select>
    </label>
    <label>价格: <input id="price" type="number" step="any" placeholder="例如 30000" /></label>
    <button id="search">搜索</button>
    <button id="save">保存查询</button>
    <button id="toggle-indicators">技术指标 ▼</button>
  </div>

  <!-- 技术指标设置面板 -->
  <div id="indicators-panel" class="indicators-panel" style="display:none;">
    <div class="indicator-group">
      <h4>MA - 简单移动平均线</h4>
      <div class="indicator-row">
        <label><input type="checkbox" id="ma5-show" checked /> MA5 <input type="number" id="ma5-period" value="5" min="1" style="width:50px" /></label>
        <label><input type="checkbox" id="ma10-show" checked /> MA10 <input type="number" id="ma10-period" value="10" min="1" style="width:50px" /></label>
        <label><input type="checkbox" id="ma20-show" checked /> MA20 <input type="number" id="ma20-period" value="20" min="1" style="width:50px" /></label>
        <label><input type="checkbox" id="ma60-show" checked /> MA60 <input type="number" id="ma60-period" value="60" min="1" style="width:50px" /></label>
      </div>
    </div>
    <div class="indicator-group">
      <h4>EMA - 指数移动平均线</h4>
      <div class="indicator-row">
        <label><input type="checkbox" id="ema21-show" /> EMA21 <input type="number" id="ema21-period" value="21" min="1" style="width:50px" /></label>
        <label><input type="checkbox" id="ema55-show" /> EMA55 <input type="number" id="ema55-period" value="55" min="1" style="width:50px" /></label>
        <label><input type="checkbox" id="ema100-show" /> EMA100 <input type="number" id="ema100-period" value="100" min="1" style="width:50px" /></label>
        <label><input type="checkbox" id="ema200-show" /> EMA200 <input type="number" id="ema200-period" value="200" min="1" style="width:50px" /></label>
      </div>
    </div>
    <div class="indicator-group">
      <h4>布林带 (Bollinger Bands)</h4>
      <div class="indicator-row">
        <label><input type="checkbox" id="bb-show" /> 显示布林带</label>
        <label>周期: <input type="number" id="bb-period" value="20" min="1" style="width:50px" /></label>
        <label>标准差倍数: <input type="number" id="bb-stddev" value="2" min="0.1" step="0.1" style="width:50px" /></label>
      </div>
    </div>
    <div style="margin-top:10px;">
      <button id="apply-indicators">应用设置</button>
    </div>
  </div>

  <!-- 图表和侧边栏容器 -->
  <div class="main-container">
    <!-- 图表区域 -->
    <div class="chart-area">
      <div id="chart"></div>
      <!-- 技术指标图例 -->
      <div class="legend">
        <strong>MA:</strong>
        <span><i style="background:orange"></i>MA5</span>
        <span><i style="background:gold"></i>MA10</span>
        <span><i style="background:blue"></i>MA20</span>
        <span><i style="background:purple"></i>MA60</span>
        <strong style="margin-left:15px">EMA:</strong>
        <span><i style="background:#00bcd4"></i>EMA21</span>
        <span><i style="background:#ff9800"></i>EMA55</span>
        <span><i style="background:#e91e63"></i>EMA100</span>
        <span><i style="background:#9c27b0"></i>EMA200</span>
        <strong style="margin-left:15px">BB:</strong>
        <span><i style="background:#2196f3"></i>布林带</span>
      </div>
    </div>

    <!-- 潜力观察列表侧边栏 -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>潜力观察列表</h3>
        <button class="toggle-btn" id="toggle-sidebar" title="收起/展开">◀</button>
      </div>
      <div class="sidebar-content">
        <div id="history-filters">
          <label>币种筛选
            <input id="filter-symbol" placeholder="如 BTCUSDT" />
          </label>
          <label>起始时间
            <input type="datetime-local" id="filter-start" />
          </label>
          <label>结束时间
            <input type="datetime-local" id="filter-end" />
          </label>
          <div style="display:flex;gap:4px;">
            <button id="filter-button">筛选</button>
            <button id="filter-reset">重置</button>
          </div>
        </div>
        <div id="history-list"></div>
        <div class="history-controls">
          <button id="clear-history">清空</button>
          <button id="export-history">导出</button>
          <input type="file" id="import-file" style="display:none" />
          <button id="import-history">导入</button>
          <button id="clear-cache">清缓存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 回测工具面板 -->
  <div style="margin-top:20px;">
    <button id="toggle-backtest">回测工具 ▼</button>
  </div>
  <div id="backtest-panel" class="backtest-panel" style="display:none;">
    <div class="backtest-controls">
      <div class="backtest-settings">
        <h4>回测参数</h4>
        <label>初始资金: <input type="number" id="initial-capital" value="10000" min="0" step="100" /> USDT</label>
        <label>每笔仓位: <select id="position-size">
          <option value="100">100%</option>
          <option value="50">50%</option>
          <option value="25">25%</option>
          <option value="10">10%</option>
        </select></label>
        <label>手续费率: <input type="number" id="fee-rate" value="0.1" min="0" max="1" step="0.01" /> %</label>
      </div>
      <div class="backtest-actions">
        <h4>交易操作</h4>
        <div style="display:flex;gap:10px;margin-bottom:10px;">
          <button id="btn-long" class="trade-btn long-btn">开多 Long</button>
          <button id="btn-short" class="trade-btn short-btn">开空 Short</button>
          <button id="btn-close" class="trade-btn close-btn">平仓 Close</button>
        </div>
        <div style="display:flex;gap:10px;">
          <button id="btn-clear-trades">清除所有交易</button>
          <button id="btn-export-trades">导出交易记录</button>
        </div>
      </div>
      <div class="backtest-stats">
        <h4>回测统计</h4>
        <div id="stats-content">
          <div class="stat-item"><span>当前资金:</span> <strong id="stat-capital">10000.00 USDT</strong></div>
          <div class="stat-item"><span>总收益:</span> <strong id="stat-profit" class="neutral">0.00 USDT</strong></div>
          <div class="stat-item"><span>收益率:</span> <strong id="stat-return" class="neutral">0.00%</strong></div>
          <div class="stat-item"><span>交易次数:</span> <strong id="stat-trades">0</strong></div>
          <div class="stat-item"><span>胜率:</span> <strong id="stat-winrate">0%</strong></div>
          <div class="stat-item"><span>最大回撤:</span> <strong id="stat-drawdown">0.00%</strong></div>
        </div>
      </div>
    </div>
    <div class="backtest-trades">
      <h4>交易记录 <span id="position-status" class="position-status">无持仓</span></h4>
      <div id="trades-list" class="trades-list"></div>
    </div>
  </div>

  <div class="hint">说明：时间自动使用浏览器本地时区。K线数据会自动缓存到Cloudflare D1数据库，重复查询时会直接使用缓存，大幅提升速度。</div>
  <div class="hint">数据来源：币安（Binance）公共API（通过Cloudflare Workers代理），支持所有币安交易对。</div>

<script>
(function(){
  // ========== API配置 ==========
  const API_BASE = '/api';  // Cloudflare Pages Functions会自动映射

  // 从服务器查询K线数据
  async function getKlinesFromDB(symbol, interval, startTime, endTime) {
    try {
      const url = `${API_BASE}/klines?symbol=${symbol}&interval=${interval}&startTime=${startTime}&endTime=${endTime}`;
      const response = await fetch(url);
      const data = await response.json();
      return Array.isArray(data) ? data : [];
    } catch (error) {
      console.error('查询K线数据失败:', error);
      return [];
    }
  }

  // 保存K线数据到服务器
  async function saveKlinesToDB(symbol, interval, klines) {
    if (!klines || klines.length === 0) return;
    try {
      const response = await fetch(`${API_BASE}/save-klines`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol, interval, klines })
      });
      const result = await response.json();
      console.log(`已保存 ${result.count} 条数据到服务器`);
    } catch (error) {
      console.error('保存K线数据失败:', error);
    }
  }

  // 通过代理请求币安API
  async function fetchBinanceKlines(symbol, interval, startTime, endTime, limit = 1000) {
    const url = `${API_BASE}/binance-proxy?symbol=${symbol}&interval=${interval}&startTime=${startTime}&endTime=${endTime}&limit=${limit}`;
    const response = await fetch(url);
    return await response.json();
  }

  // 清空K线缓存（暂不实现，需要管理后台）
  async function clearKlineCache() {
    alert('服务器版本暂不支持清空缓存功能');
  }

  // ========== 图表初始化 ==========
  const chartContainer = document.getElementById('chart');
  const chart = LightweightCharts.createChart(chartContainer, {
    layout: { background: { type: 'solid', color: '#ffffff' }, textColor: '#000' },
    rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.25 } },
    timeScale: { timeVisible: true, secondsVisible: false }
  });

  const candleSeries = chart.addCandlestickSeries();
  const volumeSeries = chart.addHistogramSeries({
    priceScaleId: '',
    scaleMargins: { top: 0.75, bottom: 0 },
    color: 'rgba(76,175,80,0.5)'
  });

  // MA系列
  const ma5Series = chart.addLineSeries({ color: 'orange', lineWidth: 1, visible: true });
  const ma10Series = chart.addLineSeries({ color: 'gold', lineWidth: 1, visible: true });
  const ma20Series = chart.addLineSeries({ color: 'blue', lineWidth: 1, visible: true });
  const ma60Series = chart.addLineSeries({ color: 'purple', lineWidth: 1, visible: true });

  // EMA系列
  const ema21Series = chart.addLineSeries({ color: '#00bcd4', lineWidth: 1, visible: false });
  const ema55Series = chart.addLineSeries({ color: '#ff9800', lineWidth: 1, visible: false });
  const ema100Series = chart.addLineSeries({ color: '#e91e63', lineWidth: 1, visible: false });
  const ema200Series = chart.addLineSeries({ color: '#9c27b0', lineWidth: 1, visible: false });

  // 布林带系列
  const bbUpperSeries = chart.addLineSeries({ color: '#2196f3', lineWidth: 1, lineStyle: 2, visible: false });
  const bbMiddleSeries = chart.addLineSeries({ color: '#2196f3', lineWidth: 1, visible: false });
  const bbLowerSeries = chart.addLineSeries({ color: '#2196f3', lineWidth: 1, lineStyle: 2, visible: false });

  let currentPriceLine = null;
  const intervalToMs = { '1m':60000,'3m':180000,'5m':300000,'15m':900000,'30m':1800000,'1h':3600000,'4h':14400000,'1d':86400000 };

  // ========== 回测工具 ==========
  let backtestState = {
    enabled: false,
    initialCapital: 10000,
    currentCapital: 10000,
    positionSize: 100,
    feeRate: 0.1,
    currentPosition: null,
    trades: [],
    tradeMarkers: []
  };

  function updateBacktestStats() {
    const initial = backtestState.initialCapital;
    const current = backtestState.currentCapital;
    const profit = current - initial;
    const returnPct = (profit / initial * 100).toFixed(2);

    document.getElementById('stat-capital').textContent = current.toFixed(2) + ' USDT';
    document.getElementById('stat-profit').textContent = profit.toFixed(2) + ' USDT';
    document.getElementById('stat-profit').className = profit > 0 ? 'profit' : (profit < 0 ? 'loss' : 'neutral');
    document.getElementById('stat-return').textContent = returnPct + '%';
    document.getElementById('stat-return').className = profit > 0 ? 'profit' : (profit < 0 ? 'loss' : 'neutral');

    const completedTrades = backtestState.trades.filter(t => t.closePrice);
    document.getElementById('stat-trades').textContent = completedTrades.length;

    const winTrades = completedTrades.filter(t => t.pnl > 0).length;
    const winRate = completedTrades.length > 0 ? (winTrades / completedTrades.length * 100).toFixed(2) : '0.00';
    document.getElementById('stat-winrate').textContent = winRate + '%';

    let peak = initial;
    let maxDrawdown = 0;
    let capital = initial;
    completedTrades.forEach(t => {
      capital += t.pnl;
      if(capital > peak) peak = capital;
      const drawdown = (peak - capital) / peak * 100;
      if(drawdown > maxDrawdown) maxDrawdown = drawdown;
    });
    document.getElementById('stat-drawdown').textContent = maxDrawdown.toFixed(2) + '%';

    const statusEl = document.getElementById('position-status');
    if(backtestState.currentPosition){
      statusEl.textContent = backtestState.currentPosition.type === 'long' ? '持多' : '持空';
      statusEl.className = 'position-status ' + backtestState.currentPosition.type;
    } else {
      statusEl.textContent = '无持仓';
      statusEl.className = 'position-status';
    }

    const hasPosition = !!backtestState.currentPosition;
    document.getElementById('btn-long').disabled = hasPosition;
    document.getElementById('btn-short').disabled = hasPosition;
    document.getElementById('btn-close').disabled = !hasPosition;
  }

  function renderTradesList() {
    const list = document.getElementById('trades-list');
    list.innerHTML = '<div class="trade-record header"><div>类型</div><div>时间</div><div>价格</div><div>数量</div><div>盈亏</div><div>资金</div></div>';

    backtestState.trades.forEach((trade, idx) => {
      const div = document.createElement('div');
      div.className = 'trade-record';

      const typeClass = trade.closePrice ? 'close' : trade.type;
      const typeText = trade.closePrice ? '平仓' : (trade.type === 'long' ? '开多' : '开空');

      const time = new Date(trade.entryTime).toLocaleString();
      const price = trade.closePrice || trade.entryPrice;
      const pnl = trade.pnl ? (trade.pnl > 0 ? '+' : '') + trade.pnl.toFixed(2) : '-';
      const pnlClass = trade.pnl > 0 ? 'profit' : (trade.pnl < 0 ? 'loss' : '');

      div.innerHTML = `
        <div><span class="trade-type ${typeClass}">${typeText}</span></div>
        <div>${time}</div>
        <div>${price.toFixed(4)}</div>
        <div>${trade.quantity.toFixed(6)}</div>
        <div class="${pnlClass}">${pnl}</div>
        <div>${trade.capitalAfter.toFixed(2)}</div>
      `;
      list.appendChild(div);
    });
  }

  function addTradeMarker(time, price, type) {
    const markers = candleSeries.markers() || [];
    const newMarker = {
      time: time,
      position: type === 'long' ? 'belowBar' : 'aboveBar',
      color: type === 'long' ? '#26a69a' : '#ef5350',
      shape: type === 'long' ? 'arrowUp' : 'arrowDown',
      text: type === 'long' ? 'L' : 'S',
      size: 2
    };
    markers.push(newMarker);
    candleSeries.setMarkers(markers);
    backtestState.tradeMarkers.push(newMarker);
  }

  function addCloseMarker(time, price, type) {
    const markers = candleSeries.markers() || [];
    const newMarker = {
      time: time,
      position: type === 'long' ? 'aboveBar' : 'belowBar',
      color: '#ff9800',
      shape: 'circle',
      text: 'C',
      size: 2
    };
    markers.push(newMarker);
    candleSeries.setMarkers(markers);
    backtestState.tradeMarkers.push(newMarker);
  }

  function openPosition(type, price, time) {
    if(backtestState.currentPosition) {
      alert('已有持仓，请先平仓');
      return;
    }

    const positionValue = backtestState.currentCapital * (backtestState.positionSize / 100);
    const fee = positionValue * (backtestState.feeRate / 100);
    const quantity = (positionValue - fee) / price;

    backtestState.currentPosition = {
      type: type,
      entryPrice: price,
      entryTime: time,
      quantity: quantity
    };

    backtestState.trades.push({
      type: type,
      entryPrice: price,
      entryTime: time,
      quantity: quantity,
      capitalAfter: backtestState.currentCapital
    });

    addTradeMarker(Math.floor(time / 1000), price, type);
    updateBacktestStats();
    renderTradesList();

    console.log(`开${type === 'long' ? '多' : '空'}: 价格=${price}, 数量=${quantity.toFixed(6)}`);
  }

  function closePosition(price, time) {
    if(!backtestState.currentPosition) {
      alert('无持仓');
      return;
    }

    const pos = backtestState.currentPosition;
    const exitValue = pos.quantity * price;
    const fee = exitValue * (backtestState.feeRate / 100);
    const entryValue = pos.quantity * pos.entryPrice;

    let pnl;
    if(pos.type === 'long'){
      pnl = exitValue - entryValue - fee - (entryValue * backtestState.feeRate / 100);
    } else {
      pnl = entryValue - exitValue - fee - (entryValue * backtestState.feeRate / 100);
    }

    backtestState.currentCapital += pnl;

    const lastTrade = backtestState.trades[backtestState.trades.length - 1];
    lastTrade.closePrice = price;
    lastTrade.closeTime = time;
    lastTrade.pnl = pnl;
    lastTrade.capitalAfter = backtestState.currentCapital;

    addCloseMarker(Math.floor(time / 1000), price, pos.type);
    backtestState.currentPosition = null;
    updateBacktestStats();
    renderTradesList();

    console.log(`平仓: 价格=${price}, 盈亏=${pnl.toFixed(2)}`);
  }

  // ========== 技术指标计算函数 ==========
  function movingAverage(data, n){
    const res=[]; let sum=0;
    for(let i=0;i<data.length;i++){
      sum+=data[i].close;
      if(i>=n) sum-=data[i-n].close;
      if(i>=n-1) res.push({time:data[i].time, value:sum/n});
    }
    return res;
  }

  function exponentialMovingAverage(data, n){
    if(data.length < n) return [];
    const res = [];
    const k = 2 / (n + 1);
    let ema = data.slice(0, n).reduce((sum, d) => sum + d.close, 0) / n;
    res.push({time: data[n-1].time, value: ema});
    for(let i = n; i < data.length; i++){
      ema = data[i].close * k + ema * (1 - k);
      res.push({time: data[i].time, value: ema});
    }
    return res;
  }

  function bollingerBands(data, period, stdDev){
    if(data.length < period) return { upper: [], middle: [], lower: [] };
    const upper = [], middle = [], lower = [];
    for(let i = period - 1; i < data.length; i++){
      const slice = data.slice(i - period + 1, i + 1);
      const avg = slice.reduce((sum, d) => sum + d.close, 0) / period;
      const variance = slice.reduce((sum, d) => sum + Math.pow(d.close - avg, 2), 0) / period;
      const std = Math.sqrt(variance);
      const time = data[i].time;
      middle.push({time, value: avg});
      upper.push({time, value: avg + stdDev * std});
      lower.push({time, value: avg - stdDev * std});
    }
    return { upper, middle, lower };
  }

  async function loadChart(symbol, timeInput, interval, priceInput, zoneType){
    // 清除旧的价格线
    if(currentPriceLine) {
      try {
        candleSeries.removePriceLine(currentPriceLine);
        currentPriceLine = null;
      } catch(e) {
        console.log('移除价格线失败:', e);
      }
    }
    const targetTs = new Date(timeInput).getTime();
    const targetDate = new Date(timeInput);
    // 获取当天的开始时间（00:00:00）
    const dayStart = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate()).getTime();
    // 获取后一天的结束时间（次日 23:59:59.999）
    const nextDayEnd = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate() + 2).getTime() - 1;

    const ms = intervalToMs[interval] || 3600000;
    const totalCandles = Math.ceil((nextDayEnd - dayStart) / ms);

    // 先尝试从服务器数据库获取数据
    let cachedData = await getKlinesFromDB(symbol, interval, dayStart, nextDayEnd);
    console.log(`从服务器缓存获取 ${cachedData.length} 条数据`);

    let data;
    // 如果缓存数据不足，从币安API获取
    if (cachedData.length < totalCandles * 0.9) {
      console.log(`缓存不足，通过代理从币安API获取数据...`);
      // 如果需要的K线数量超过1000，就分批并发请求
      const batchSize = 1000;
      const batches = Math.ceil(totalCandles / batchSize);

      const promises = [];
      for(let i = 0; i < batches; i++){
        const batchStart = dayStart + i * batchSize * ms;
        const batchEnd = Math.min(dayStart + (i + 1) * batchSize * ms, nextDayEnd);
        promises.push(fetchBinanceKlines(symbol, interval, batchStart, batchEnd, batchSize));
      }

      const results = await Promise.all(promises);
      const apiData = results.flat();

      if(!Array.isArray(apiData)||apiData.length===0)throw new Error('无数据');

      // 从原始API字符串数据中获取精度
      let apiPrecision = 2;
      if(apiData.length > 0 && apiData[0][4]) {
        const priceStr = apiData[0][4].toString();
        if(priceStr.indexOf('.') !== -1) {
          const decimalPart = priceStr.split('.')[1];
          apiPrecision = decimalPart ? Math.min(decimalPart.length, 4) : 2;
        }
      }
      // 保存精度到全局变量供后续使用
      window.currentPrecision = apiPrecision;
      console.log(`价格精度: ${apiPrecision}位小数`);

      // 保存到服务器数据库
      await saveKlinesToDB(symbol, interval, apiData);

      // 转换API数据格式
      data = apiData.map(d=>({
        time: d[0],
        open: +d[1],
        high: +d[2],
        low: +d[3],
        close: +d[4],
        volume: +d[5]
      }));
    } else {
      console.log('使用服务器缓存数据');
      // 使用缓存数据时，设置默认精度
      if(!window.currentPrecision) {
        window.currentPrecision = 4;
      }
      // 使用缓存数据（已经是正确格式）
      data = cachedData.map(d=>({
        time: d[0],
        open: +d[1],
        high: +d[2],
        low: +d[3],
        close: +d[4],
        volume: +d[5]
      }));
    }

    // 按时间排序
    data.sort((a, b) => a.time - b.time);

    if(!Array.isArray(data)||data.length===0)throw new Error('无数据');

    const candles = data.map(d=>({
      time: Math.floor(d.time / 1000),
      open: d.open,
      high: d.high,
      low: d.low,
      close: d.close,
      volume: d.volume
    }));

    // 使用从API获取的精度，如果没有则默认4位
    const precision = window.currentPrecision || 4;
    chart.applyOptions({
      rightPriceScale: {
        scaleMargins: { top: 0.1, bottom: 0.25 },
        precision: precision,
        minMove: Math.pow(10, -precision)
      }
    });

    candleSeries.setData(candles);
    volumeSeries.setData(candles.map(c=>({
      time:c.time,value:c.volume,color:c.close>=c.open?'rgba(76,175,80,0.5)':'rgba(255,82,82,0.5)'
    })));

    // 根据用户设置显示技术指标
    // MA指标
    if(document.getElementById('ma5-show').checked){
      const period = parseInt(document.getElementById('ma5-period').value);
      ma5Series.setData(movingAverage(candles, period));
      ma5Series.applyOptions({ visible: true });
    } else {
      ma5Series.applyOptions({ visible: false });
    }
    if(document.getElementById('ma10-show').checked){
      const period = parseInt(document.getElementById('ma10-period').value);
      ma10Series.setData(movingAverage(candles, period));
      ma10Series.applyOptions({ visible: true });
    } else {
      ma10Series.applyOptions({ visible: false });
    }
    if(document.getElementById('ma20-show').checked){
      const period = parseInt(document.getElementById('ma20-period').value);
      ma20Series.setData(movingAverage(candles, period));
      ma20Series.applyOptions({ visible: true });
    } else {
      ma20Series.applyOptions({ visible: false });
    }
    if(document.getElementById('ma60-show').checked){
      const period = parseInt(document.getElementById('ma60-period').value);
      ma60Series.setData(movingAverage(candles, period));
      ma60Series.applyOptions({ visible: true });
    } else {
      ma60Series.applyOptions({ visible: false });
    }

    // EMA指标
    if(document.getElementById('ema21-show').checked){
      const period = parseInt(document.getElementById('ema21-period').value);
      ema21Series.setData(exponentialMovingAverage(candles, period));
      ema21Series.applyOptions({ visible: true });
    } else {
      ema21Series.applyOptions({ visible: false });
    }
    if(document.getElementById('ema55-show').checked){
      const period = parseInt(document.getElementById('ema55-period').value);
      ema55Series.setData(exponentialMovingAverage(candles, period));
      ema55Series.applyOptions({ visible: true });
    } else {
      ema55Series.applyOptions({ visible: false });
    }
    if(document.getElementById('ema100-show').checked){
      const period = parseInt(document.getElementById('ema100-period').value);
      ema100Series.setData(exponentialMovingAverage(candles, period));
      ema100Series.applyOptions({ visible: true });
    } else {
      ema100Series.applyOptions({ visible: false });
    }
    if(document.getElementById('ema200-show').checked){
      const period = parseInt(document.getElementById('ema200-period').value);
      ema200Series.setData(exponentialMovingAverage(candles, period));
      ema200Series.applyOptions({ visible: true });
    } else {
      ema200Series.applyOptions({ visible: false });
    }

    // 布林带
    if(document.getElementById('bb-show').checked){
      const period = parseInt(document.getElementById('bb-period').value);
      const stdDev = parseFloat(document.getElementById('bb-stddev').value);
      const bb = bollingerBands(candles, period, stdDev);
      bbUpperSeries.setData(bb.upper);
      bbMiddleSeries.setData(bb.middle);
      bbLowerSeries.setData(bb.lower);
      bbUpperSeries.applyOptions({ visible: true });
      bbMiddleSeries.applyOptions({ visible: true });
      bbLowerSeries.applyOptions({ visible: true });
    } else {
      bbUpperSeries.applyOptions({ visible: false });
      bbMiddleSeries.applyOptions({ visible: false });
      bbLowerSeries.applyOptions({ visible: false });
    }

    const price=parseFloat(priceInput);
    const isBottom = zoneType === 'bottom';
    currentPriceLine = candleSeries.createPriceLine({
      price,
      color: isBottom ? '#26a69a' : '#ef5350',
      lineWidth: 2,
      axisLabelVisible: true,
      title: isBottom ? '兜底价' : '探顶价',
      lineStyle: 0
    });

    const targetSec = Math.floor(targetTs / 1000);
    let nearest=null, diff=Infinity;
    for(const c of candles){const d=Math.abs(c.time-targetSec);if(d<diff){diff=d;nearest=c;}}
    if(nearest){
      candleSeries.setMarkers([{time:nearest.time,position:'belowBar',color:'blue',shape:'arrowUp',text:'发布时间',size:3}]);
      const idx=candles.findIndex(c=>c.time===nearest.time);
      const from=candles[Math.max(0,idx-80)].time;
      const to=candles[Math.min(candles.length-1,idx+80)].time;
      chart.timeScale().setVisibleRange({from,to});
    }
  }

  // 搜索按钮
  document.getElementById('search').addEventListener('click', async ()=>{
    const symbol = document.getElementById('symbol').value.trim().toUpperCase();
    const timeInput = document.getElementById('time').value;
    const interval = document.getElementById('interval').value;
    const priceInput = document.getElementById('price').value.trim();
    const zoneType = document.getElementById('zone-type').value;
    if(!symbol||!timeInput||!priceInput){alert('请输入完整参数');return;}
    try{ await loadChart(symbol,timeInput,interval,priceInput,zoneType); }
    catch(e){alert('加载失败:'+e.message);}
  });

  // 周期切换自动加载
  document.getElementById('interval').addEventListener('change', async ()=>{
    const symbol = document.getElementById('symbol').value.trim().toUpperCase();
    const timeInput = document.getElementById('time').value;
    const interval = document.getElementById('interval').value;
    const priceInput = document.getElementById('price').value.trim();
    const zoneType = document.getElementById('zone-type').value;
    if(!symbol||!timeInput||!priceInput){
      console.log('参数不完整，请先填写完整参数后再切换周期');
      return;
    }
    try{ await loadChart(symbol,timeInput,interval,priceInput,zoneType); }
    catch(e){alert('加载失败:'+e.message);}
  });

  // 技术指标面板切换
  document.getElementById('toggle-indicators').addEventListener('click', ()=>{
    const panel = document.getElementById('indicators-panel');
    const btn = document.getElementById('toggle-indicators');
    if(panel.style.display === 'none'){
      panel.style.display = 'block';
      btn.textContent = '技术指标 ▲';
    } else {
      panel.style.display = 'none';
      btn.textContent = '技术指标 ▼';
    }
  });

  // 应用指标设置
  document.getElementById('apply-indicators').addEventListener('click', ()=>{
    document.getElementById('search').click();
  });

  // ========== 回测工具事件监听器 ==========
  // 回测面板切换
  document.getElementById('toggle-backtest').addEventListener('click', ()=>{
    const panel = document.getElementById('backtest-panel');
    const btn = document.getElementById('toggle-backtest');
    if(panel.style.display === 'none'){
      panel.style.display = 'block';
      btn.textContent = '回测工具 ▲';
    } else {
      panel.style.display = 'none';
      btn.textContent = '回测工具 ▼';
    }
  });

  // 参数更新
  document.getElementById('initial-capital').addEventListener('change', (e)=>{
    const value = parseFloat(e.target.value);
    if(value > 0) {
      backtestState.initialCapital = value;
      backtestState.currentCapital = value;
      updateBacktestStats();
    }
  });
  document.getElementById('position-size').addEventListener('change', (e)=>{
    backtestState.positionSize = parseFloat(e.target.value);
  });
  document.getElementById('fee-rate').addEventListener('change', (e)=>{
    backtestState.feeRate = parseFloat(e.target.value);
  });

  // 图表点击事件
  let selectedPoint = null;
  chart.subscribeClick((param) => {
    if (!param.point || !param.time) return;
    const price = param.seriesPrices.get(candleSeries);
    if (!price) return;

    selectedPoint = {
      time: param.time * 1000,
      price: typeof price === 'object' ? price.close : price
    };

    console.log(`点击位置: 时间=${new Date(selectedPoint.time).toLocaleString()}, 价格=${selectedPoint.price.toFixed(4)}`);
  });

  // 交易按钮
  document.getElementById('btn-long').addEventListener('click', ()=>{
    if(!selectedPoint) {
      alert('请先点击图表选择价格位置');
      return;
    }
    openPosition('long', selectedPoint.price, selectedPoint.time);
  });

  document.getElementById('btn-short').addEventListener('click', ()=>{
    if(!selectedPoint) {
      alert('请先点击图表选择价格位置');
      return;
    }
    openPosition('short', selectedPoint.price, selectedPoint.time);
  });

  document.getElementById('btn-close').addEventListener('click', ()=>{
    if(!selectedPoint) {
      alert('请先点击图表选择平仓位置');
      return;
    }
    closePosition(selectedPoint.price, selectedPoint.time);
  });

  // 清除所有交易
  document.getElementById('btn-clear-trades').addEventListener('click', ()=>{
    if(!confirm('确定清除所有交易记录吗？')) return;

    backtestState.currentCapital = backtestState.initialCapital;
    backtestState.currentPosition = null;
    backtestState.trades = [];
    backtestState.tradeMarkers = [];
    candleSeries.setMarkers([]);

    updateBacktestStats();
    renderTradesList();
  });

  // 导出交易记录
  document.getElementById('btn-export-trades').addEventListener('click', ()=>{
    if(backtestState.trades.length === 0) {
      alert('暂无交易记录');
      return;
    }

    const data = {
      initialCapital: backtestState.initialCapital,
      finalCapital: backtestState.currentCapital,
      profit: backtestState.currentCapital - backtestState.initialCapital,
      trades: backtestState.trades
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backtest_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // 保存查询、导出导入、筛选等逻辑原样保留
  function renderHistory(filter={}) {
    const list = document.getElementById('history-list');
    let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
    if(filter.symbol){
      const s = filter.symbol.trim().toUpperCase();
      history = history.filter(item => item.symbol.toUpperCase().includes(s));
    }
    if(filter.start){
      const startTs = new Date(filter.start).getTime();
      history = history.filter(item => new Date(item.time).getTime() >= startTs);
    }
    if(filter.end){
      const endTs = new Date(filter.end).getTime();
      history = history.filter(item => new Date(item.time).getTime() <= endTs);
    }
    history.sort((a,b)=>new Date(b.time) - new Date(a.time));
    list.innerHTML = '';
    history.forEach(item => {
      const div = document.createElement('div');
      const zoneType = item.zoneType || 'bottom';
      div.className = `history-item ${zoneType}-zone`;
      const zoneLabel = zoneType === 'bottom' ? '兜底区' : '探顶区';
      div.innerHTML = `
        <div style="font-weight:bold;margin-bottom:2px;">${item.symbol} - ${zoneLabel}</div>
        <div style="font-size:11px;color:#666;">${item.interval} | ${item.time}</div>
        <div style="font-size:11px;color:#666;">价格: ${item.price}</div>
      `;
      div.onclick = () => {
        document.getElementById('symbol').value = item.symbol;
        document.getElementById('interval').value = item.interval;
        document.getElementById('time').value = item.time;
        document.getElementById('price').value = item.price;
        document.getElementById('zone-type').value = zoneType;
        document.getElementById('search').click();
      };
      list.appendChild(div);
    });
  }

  document.getElementById('save').addEventListener('click', ()=>{
    const symbol = document.getElementById('symbol').value.trim().toUpperCase();
    const time = document.getElementById('time').value;
    const interval = document.getElementById('interval').value;
    const price = document.getElementById('price').value.trim();
    const zoneType = document.getElementById('zone-type').value;
    if(!symbol||!time||!price){alert('请输入完整参数');return;}
    const history = JSON.parse(localStorage.getItem('searchHistory')||'[]');
    history.unshift({symbol,time,interval,price,zoneType});
    localStorage.setItem('searchHistory',JSON.stringify(history));
    renderHistory();
  });

  // 其余导入导出、筛选、初始化部分保持一致
  document.getElementById('filter-button').addEventListener('click', () => {
    const symbol = document.getElementById('filter-symbol').value;
    const start = document.getElementById('filter-start').value;
    const end = document.getElementById('filter-end').value;
    renderHistory({symbol,start,end});
  });
  document.getElementById('filter-reset').addEventListener('click', () => {
    document.getElementById('filter-symbol').value='';
    document.getElementById('filter-start').value='';
    document.getElementById('filter-end').value='';
    renderHistory();
  });
  document.getElementById('clear-history').addEventListener('click',()=>{localStorage.removeItem('searchHistory');renderHistory();});
  document.getElementById('export-history').addEventListener('click', ()=>{
    const history = localStorage.getItem('searchHistory');
    if(!history){alert('暂无历史记录'); return;}
    const blob = new Blob([history], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `search_history_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
  const importFile = document.getElementById('import-file');
  document.getElementById('import-history').addEventListener('click', ()=>{ importFile.click(); });
  importFile.addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try{
        const data = JSON.parse(evt.target.result);
        if(!Array.isArray(data)) throw new Error('文件格式错误');
        let history = JSON.parse(localStorage.getItem('searchHistory')||'[]');
        history = history.concat(data);
        history.sort((a,b)=>new Date(b.time)-new Date(a.time));
        localStorage.setItem('searchHistory', JSON.stringify(history));
        renderHistory();
        alert('导入成功');
      }catch(err){ alert('导入失败:'+err.message); }
    };
    reader.readAsText(file);
    importFile.value='';
  });

  // 清空K线缓存
  document.getElementById('clear-cache').addEventListener('click', async ()=>{
    if(confirm('确定要清空所有K线缓存吗？')){
      try{
        await clearKlineCache();
        alert('K线缓存已清空');
      }catch(err){
        alert('清空失败:'+err.message);
      }
    }
  });

  // 侧边栏展开/隐藏功能
  document.getElementById('toggle-sidebar').addEventListener('click', ()=>{
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-sidebar');
    const isCollapsed = sidebar.classList.toggle('collapsed');
    toggleBtn.textContent = isCollapsed ? '▶' : '◀';
    toggleBtn.title = isCollapsed ? '展开' : '收起';
  });

  // 初始化
  (function(){
    // 初始化时间输入框
    const dt = new Date();
    const pad = n => String(n).padStart(2,'0');
    const s = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    document.getElementById('time').value = s;
    renderHistory();
  })();
})();
</script>
</body>
</html>
